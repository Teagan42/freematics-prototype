<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freematics BLE Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #212529;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e9ecef;
            }
        }
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (prefers-color-scheme: dark) {
            .header {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .connect-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .connect-btn:hover {
            background: #0056b3;
        }
        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        .status-indicator.connected {
            background: #28a745;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            cursor: help;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        @media (prefers-color-scheme: dark) {
            .metric-card {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            transition: color 0.3s ease;
            min-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-variant-numeric: tabular-nums;
            font-family: 'Courier New', monospace;
        }
        .metric-value.normal { color: #28a745; }
        .metric-value.warning { color: #ffc107; }
        .metric-value.danger { color: #dc3545; }
        .metric-value.info { color: #007bff; }
        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        @media (prefers-color-scheme: dark) {
            .chart-container {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .gps-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (prefers-color-scheme: dark) {
            .gps-container {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .gps-coords {
            font-family: monospace;
            font-size: 1.1em;
            color: #495057;
            margin: 10px 0;
        }
        .data-log {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        @media (prefers-color-scheme: dark) {
            .data-log {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .log-entry {
            font-family: monospace;
            font-size: 0.9em;
            padding: 8px;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
            border-radius: 4px;
            margin: 2px 0;
            line-height: 1.4;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        
        @media (prefers-color-scheme: dark) {
            .log-entry {
                border-bottom: 1px solid #495057;
            }
        }
        .log-entry.error {
            color: #dc3545;
            background-color: #f8d7da;
        }
        .log-entry.status {
            color: #0c5460;
            background-color: #d1ecf1;
        }
        .log-entry.heartbeat {
            color: #155724;
            background-color: #d4edda;
        }
        .log-entry.connect {
            color: #004085;
            background-color: #cce5ff;
            font-weight: bold;
        }
        .log-entry.disconnect {
            color: #721c24;
            background-color: #f5c6cb;
            font-weight: bold;
        }
        .log-entry.tx {
            color: #856404;
            background-color: #fff3cd;
            font-style: italic;
        }
        .log-entry.system {
            color: #6c757d;
            background-color: #f8f9fa;
        }
        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        @media (prefers-color-scheme: dark) {
            .status-panel {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .status-item {
            display: inline-block;
            margin: 5px 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-item.real { background: #d4edda; color: #155724; }
        .status-item.simulated { background: #fff3cd; color: #856404; }
        .status-item.disabled { background: #e2e3e5; color: #6c757d; }
        .status-item.ok { background: #d4edda; color: #155724; }
        .status-item.fail { background: #f8d7da; color: #721c24; }
        .status-item.off { background: #e2e3e5; color: #6c757d; }
        .sim-control-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .sim-control-btn:hover {
            background: #138496;
        }
        .sim-control-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .sim-control-btn.stop {
            background: #dc3545;
        }
        .sim-control-btn.stop:hover {
            background: #c82333;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
            overflow-x: auto;
        }
        
        @media (prefers-color-scheme: dark) {
            .tabs {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background: #f8f9fa;
        }
        .tab.active {
            border-bottom-color: #007bff;
            background: #f8f9fa;
            color: #007bff;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        @media (prefers-color-scheme: dark) {
            .tab-content {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
        }
        .metric-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            max-width: 300px;
            white-space: normal;
            text-align: left;
            line-height: 1.4;
        }
        .metric-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .metric-card:hover .metric-tooltip,
        .compact-metric:hover .metric-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .metric-info {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            font-size: 0.7em;
            line-height: 16px;
            text-align: center;
            margin-left: 5px;
            cursor: help;
            vertical-align: middle;
        }
        .range-indicator {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 5px;
            display: block;
        }
        .range-indicator.normal { color: #28a745; }
        .range-indicator.warning { color: #ffc107; }
        .range-indicator.danger { color: #dc3545; }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .compact-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .compact-metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            position: relative;
            cursor: help;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        @media (prefers-color-scheme: dark) {
            .compact-metric {
                background: #3a3a3a;
                border: 1px solid #495057;
            }
            .gps-container {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            .gps-coords {
                color: #adb5bd;
            }
        }
        .compact-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
            min-height: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-variant-numeric: tabular-nums;
            font-family: 'Courier New', monospace;
        }
        .compact-label {
            color: #6c757d;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (prefers-color-scheme: dark) {
            .compact-label {
                color: #adb5bd;
            }
            .log-entry.error {
                color: #f5c2c7;
                background-color: #2c0b0e;
            }
            .log-entry.status {
                color: #9eeaf9;
                background-color: #055160;
            }
            .log-entry.heartbeat {
                color: #a3cfbb;
                background-color: #0f2419;
            }
            .log-entry.connect {
                color: #9ec5fe;
                background-color: #031633;
            }
            .log-entry.disconnect {
                color: #f1aeb5;
                background-color: #2c0b0e;
            }
            .log-entry.tx {
                color: #e2e3e5;
                background-color: #332701;
            }
            .log-entry.system {
                color: #adb5bd;
                background-color: #212529;
            }
        }
        @media (max-width: 768px) {
            .dashboard {
                padding: 10px;
            }
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .metrics-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .metric-card {
                padding: 15px 10px;
            }
            .metric-value {
                font-size: 2em;
            }
            .tab {
                padding: 12px 15px;
                font-size: 0.9em;
            }
            .tab-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function FreematicsDashboard() {
            const [isConnected, setIsConnected] = useState(false);
            const [device, setDevice] = useState(null);
            const [characteristic, setCharacteristic] = useState(null);
            const [error, setError] = useState(null);
            const [apiVersionError, setApiVersionError] = useState(null);
            const [data, setData] = useState({
                rpm: 0,
                speed: 0,
                coolant: 0,
                enginePressure: 0,
                batteryVoltage: 0,
                ambientTemp: 0,
                gps: { lat: 0, lng: 0, satellites: 0 },
                timestamp: 0,
                dataMode: 'DISABLED',
                lastError: '',
                systemStatus: {},
                simulationRunning: false,
                apiVersion: null,
                // Additional engine parameters
                engineLoad: 0,
                throttlePos: 0,
                intakeTemp: 0,
                oilTemp: 0,
                exhaustTemp: 0,
                fuelPressure: 0,
                fuelLevel: 0,
                fuelTrimShort: 0,
                fuelTrimLong: 0,
                fuelRate: 0,
                mafFlow: 0,
                o2Voltage: 0,
                catalystTemp: 0,
                boostPressure: 0,
                turboRpm: 0
            });
            
            // Client-side simulation state
            const [clientSimulation, setClientSimulation] = useState({
                enabled: false,
                startTime: null,
                interval: null
            });
            
            const [diagnosticResults, setDiagnosticResults] = useState('');
            const [diagnosticRunning, setDiagnosticRunning] = useState(false);
            const [diagnosticError, setDiagnosticError] = useState(null);
            const [dataParseErrors, setDataParseErrors] = useState([]);
            
            // Expected API version - update this when making breaking changes
            const EXPECTED_API_VERSION = 1;
            const [dataHistory, setDataHistory] = useState([]);
            const [rawDataLog, setRawDataLog] = useState([]);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const tempChartRef = useRef(null);
            const tempChartInstance = useRef(null);
            const percentChartRef = useRef(null);
            const percentChartInstance = useRef(null);
            const fuelChartRef = useRef(null);
            const fuelChartInstance = useRef(null);
            const [activeTab, setActiveTab] = useState('overview');

            // Initialize charts
            useEffect(() => {
                const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const textColor = isDarkMode ? '#e9ecef' : '#666';
                const gridColor = isDarkMode ? '#495057' : '#e0e0e0';

                // Main Performance Chart
                if (chartRef.current && !chartInstance.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'RPM',
                                    data: [],
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Speed (mph)',
                                    data: [],
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Time (seconds)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'RPM', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'Speed (mph)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { drawOnChartArea: false, color: gridColor }
                                }
                            },
                            plugins: {
                                title: { display: true, text: 'Engine Performance', color: textColor },
                                legend: { labels: { color: textColor } }
                            }
                        }
                    });
                }

                // Temperature Chart
                if (tempChartRef.current && !tempChartInstance.current) {
                    const ctx = tempChartRef.current.getContext('2d');
                    tempChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Coolant Temp (°F)',
                                    data: [],
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Intake Temp (°F)',
                                    data: [],
                                    borderColor: '#17a2b8',
                                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Oil Temp (°F)',
                                    data: [],
                                    borderColor: '#fd7e14',
                                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Exhaust Temp (°F)',
                                    data: [],
                                    borderColor: '#6f42c1',
                                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                                    yAxisID: 'y'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Time (seconds)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    title: { display: true, text: 'Temperature (°F)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                }
                            },
                            plugins: {
                                title: { display: true, text: 'Temperature Monitoring', color: textColor },
                                legend: { labels: { color: textColor } }
                            }
                        }
                    });
                }

                // Percentage Chart
                if (percentChartRef.current && !percentChartInstance.current) {
                    const ctx = percentChartRef.current.getContext('2d');
                    percentChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Engine Load (%)',
                                    data: [],
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Throttle Position (%)',
                                    data: [],
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Fuel Level (%)',
                                    data: [],
                                    borderColor: '#ffc107',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    yAxisID: 'y'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Time (seconds)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    min: 0,
                                    max: 100,
                                    title: { display: true, text: 'Percentage (%)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                }
                            },
                            plugins: {
                                title: { display: true, text: 'System Load & Levels', color: textColor },
                                legend: { labels: { color: textColor } }
                            }
                        }
                    });
                }

                // Fuel System Chart
                if (fuelChartRef.current && !fuelChartInstance.current) {
                    const ctx = fuelChartRef.current.getContext('2d');
                    fuelChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Fuel Pressure (psi)',
                                    data: [],
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Fuel Rate (L/h)',
                                    data: [],
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    yAxisID: 'y1'
                                },
                                {
                                    label: 'Short Term Trim (%)',
                                    data: [],
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    yAxisID: 'y2'
                                },
                                {
                                    label: 'Long Term Trim (%)',
                                    data: [],
                                    borderColor: '#6f42c1',
                                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                                    yAxisID: 'y2'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Time (seconds)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'Pressure (psi)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'Flow Rate (L/h)', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { drawOnChartArea: false, color: gridColor }
                                },
                                y2: {
                                    type: 'linear',
                                    display: false,
                                    min: -25,
                                    max: 25,
                                    title: { display: true, text: 'Trim (%)', color: textColor }
                                }
                            },
                            plugins: {
                                title: { display: true, text: 'Fuel System Analysis', color: textColor },
                                legend: { labels: { color: textColor } }
                            }
                        }
                    });
                }
            }, []);

            // Update charts when data changes
            useEffect(() => {
                if (dataHistory.length > 0) {
                    const startTime = dataHistory[0].timestamp;
                    const timeLabels = dataHistory.map(d => ((d.timestamp - startTime) / 1000).toFixed(1));

                    // Update main performance chart
                    if (chartInstance.current) {
                        const chart = chartInstance.current;
                        chart.data.labels = timeLabels;
                        chart.data.datasets[0].data = dataHistory.map(d => d.rpm || 0);
                        chart.data.datasets[1].data = dataHistory.map(d => d.speed || 0);

                        if (chart.data.labels.length > 50) {
                            chart.data.labels = chart.data.labels.slice(-50);
                            chart.data.datasets[0].data = chart.data.datasets[0].data.slice(-50);
                            chart.data.datasets[1].data = chart.data.datasets[1].data.slice(-50);
                        }
                        chart.update('none');
                    }

                    // Update temperature chart
                    if (tempChartInstance.current) {
                        const chart = tempChartInstance.current;
                        chart.data.labels = timeLabels;
                        chart.data.datasets[0].data = dataHistory.map(d => d.coolant || 0);
                        chart.data.datasets[1].data = dataHistory.map(d => d.intakeTemp || 0);
                        chart.data.datasets[2].data = dataHistory.map(d => d.oilTemp || 0);
                        chart.data.datasets[3].data = dataHistory.map(d => d.exhaustTemp || 0);

                        if (chart.data.labels.length > 50) {
                            chart.data.labels = chart.data.labels.slice(-50);
                            chart.data.datasets.forEach(dataset => {
                                dataset.data = dataset.data.slice(-50);
                            });
                        }
                        chart.update('none');
                    }

                    // Update percentage chart
                    if (percentChartInstance.current) {
                        const chart = percentChartInstance.current;
                        chart.data.labels = timeLabels;
                        chart.data.datasets[0].data = dataHistory.map(d => d.engineLoad || 0);
                        chart.data.datasets[1].data = dataHistory.map(d => d.throttlePos || 0);
                        chart.data.datasets[2].data = dataHistory.map(d => d.fuelLevel || 0);

                        if (chart.data.labels.length > 50) {
                            chart.data.labels = chart.data.labels.slice(-50);
                            chart.data.datasets.forEach(dataset => {
                                dataset.data = dataset.data.slice(-50);
                            });
                        }
                        chart.update('none');
                    }

                    // Update fuel chart
                    if (fuelChartInstance.current) {
                        const chart = fuelChartInstance.current;
                        chart.data.labels = timeLabels;
                        chart.data.datasets[0].data = dataHistory.map(d => d.fuelPressure || 0);
                        chart.data.datasets[1].data = dataHistory.map(d => d.fuelRate || 0);
                        chart.data.datasets[2].data = dataHistory.map(d => d.fuelTrimShort || 0);
                        chart.data.datasets[3].data = dataHistory.map(d => d.fuelTrimLong || 0);

                        if (chart.data.labels.length > 50) {
                            chart.data.labels = chart.data.labels.slice(-50);
                            chart.data.datasets.forEach(dataset => {
                                dataset.data = dataset.data.slice(-50);
                            });
                        }
                        chart.update('none');
                    }
                }
            }, [dataHistory]);

            const connectToDevice = async () => {
                try {
                    setError(null);

                    if (!navigator.bluetooth) {
                        throw new Error('Web Bluetooth is not supported in this browser. Please use Chrome/Edge with HTTPS.');
                    }

                    // Check if we're on HTTPS (required for Web Bluetooth)
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        throw new Error('Web Bluetooth requires HTTPS. Please serve this page over HTTPS.');
                    }

                    console.log('Requesting Bluetooth device...');
                    
                    // Add connection event to log
                    setRawDataLog(prev => [...prev, {
                        timestamp: new Date().toLocaleTimeString(),
                        data: 'Initiating Bluetooth connection...',
                        type: 'system'
                    }]);
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [
                            '12345678-1234-1234-1234-123456789abc',
                            '0000180f-0000-1000-8000-00805f9b34fb', // Battery Service
                            '0000180a-0000-1000-8000-00805f9b34fb'  // Device Information Service
                        ]
                    }).catch(err => {
                        if (err.name === 'NotFoundError') {
                            throw new Error('No Bluetooth device found. Make sure the device is powered on and in range.');
                        }
                        throw err;
                    });

                    console.log('Connecting to GATT server...');
                    console.log('Device name:', device.name);
                    console.log('Device ID:', device.id);
                    
                    const server = await device.gatt.connect();


                    console.log('Getting service...');
                    let service;
                    try {
                        service = await server.getPrimaryService('12345678-1234-1234-1234-123456789abc');
                    } catch (serviceErr) {
                        console.error('Service not found, trying to discover available services...');
                        
                        // Try to get all available services for debugging
                        try {
                            const services = await server.getPrimaryServices();
                            console.log('Available services:', services.map(s => s.uuid));
                            
                            // Try common service UUIDs
                            const commonServices = [
                                '0000180f-0000-1000-8000-00805f9b34fb', // Battery Service
                                '0000180a-0000-1000-8000-00805f9b34fb', // Device Information
                                '6e400001-b5a3-f393-e0a9-e50e24dcca9e'  // Nordic UART Service
                            ];
                            
                            for (const serviceUuid of commonServices) {
                                try {
                                    service = await server.getPrimaryService(serviceUuid);
                                    console.log('Using service:', serviceUuid);
                                    break;
                                } catch (e) {
                                    // Continue trying
                                }
                            }
                            
                            if (!service && services.length > 0) {
                                // Use the first available service
                                service = services[0];
                                console.log('Using first available service:', service.uuid);
                            }
                        } catch (discoveryErr) {
                            console.error('Service discovery failed:', discoveryErr);
                        }
                        
                        if (!service) {
                            throw new Error('No compatible service found. Make sure the device is a Freematics device with BLE enabled.');
                        }
                    }

                    console.log('Getting characteristic...');
                    let characteristic;
                    try {
                        characteristic = await service.getCharacteristic('12345678-1234-1234-1234-123456789abc');
                    } catch (charErr) {
                        console.error('Characteristic not found, trying to discover available characteristics...');
                        
                        try {
                            const characteristics = await service.getCharacteristics();
                            console.log('Available characteristics:', characteristics.map(c => c.uuid));
                            
                            // Try common characteristic UUIDs
                            const commonCharacteristics = [
                                '6e400002-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART TX
                                '6e400003-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART RX
                                '00002a19-0000-1000-8000-00805f9b34fb'  // Battery Level
                            ];
                            
                            for (const charUuid of commonCharacteristics) {
                                try {
                                    characteristic = await service.getCharacteristic(charUuid);
                                    console.log('Using characteristic:', charUuid);
                                    break;
                                } catch (e) {
                                    // Continue trying
                                }
                            }
                            
                            if (!characteristic && characteristics.length > 0) {
                                // Use the first available characteristic that supports notifications
                                for (const char of characteristics) {
                                    if (char.properties.notify || char.properties.read) {
                                        characteristic = char;
                                        console.log('Using first compatible characteristic:', char.uuid);
                                        break;
                                    }
                                }
                            }
                        } catch (discoveryErr) {
                            console.error('Characteristic discovery failed:', discoveryErr);
                        }
                        
                        if (!characteristic) {
                            throw new Error('No compatible characteristic found. Device may not support the expected BLE protocol.');
                        }
                    }

                    // Start notifications if supported
                    if (characteristic.properties.notify) {
                        await characteristic.startNotifications();
                        characteristic.addEventListener('characteristicvaluechanged', handleDataReceived);
                        console.log('Notifications started successfully');
                        
                        // Send initial ping to device
                        setTimeout(() => {
                            if (characteristic && device.gatt.connected) {
                                const pingMessage = 'CMD:PING';
                                characteristic.writeValue(new TextEncoder().encode(pingMessage));
                                console.log('Sent ping to device:', pingMessage);
                                
                                setRawDataLog(prev => [...prev, {
                                    timestamp: new Date().toLocaleTimeString(),
                                    data: 'TX: ' + pingMessage,
                                    type: 'tx'
                                }]);
                            }
                        }, 1000);
                        
                    } else if (characteristic.properties.read) {
                        console.log('Device supports read but not notifications, will poll for data');
                        // Set up polling for read-only characteristics
                        const pollData = async () => {
                            try {
                                const value = await characteristic.readValue();
                                handleDataReceived({ target: { value } });
                            } catch (readErr) {
                                console.error('Read error:', readErr);
                            }
                        };
                        setInterval(pollData, 1000); // Poll every second
                    } else {
                        console.warn('Characteristic does not support notifications or reading');
                    }

                    setDevice(device);
                    setCharacteristic(characteristic);
                    setIsConnected(true);

                    device.addEventListener('gattserverdisconnected', handleDisconnection);
                    
                    // Log successful connection
                    setRawDataLog(prev => [...prev, {
                        timestamp: new Date().toLocaleTimeString(),
                        data: `Connected to ${device.name || 'Unknown Device'}`,
                        type: 'connect'
                    }]);

                } catch (err) {
                    console.error('Connection failed:', err);
                    setError(`Connection failed: ${err.message}`);
                }
            };

            const handleDisconnection = () => {
                console.log('Device disconnected');
                setIsConnected(false);
                setDevice(null);
                setCharacteristic(null);
                
                // Log disconnection
                setRawDataLog(prev => [...prev, {
                    timestamp: new Date().toLocaleTimeString(),
                    data: 'Device disconnected',
                    type: 'disconnect'
                }]);
            };

            const validateApiVersion = (receivedVersion) => {
                if (receivedVersion === null || receivedVersion === undefined) {
                    setApiVersionError({
                        type: 'missing',
                        message: 'Device firmware does not report API version. Please update the firmware.'
                    });
                    return false;
                } else if (receivedVersion > EXPECTED_API_VERSION) {
                    setApiVersionError({
                        type: 'newer',
                        message: `Device firmware API version (${receivedVersion}) is newer than dashboard expects (${EXPECTED_API_VERSION}). Please update the dashboard.`
                    });
                    return false;
                } else if (receivedVersion < EXPECTED_API_VERSION) {
                    setApiVersionError({
                        type: 'older',
                        message: `Device firmware API version (${receivedVersion}) is older than dashboard expects (${EXPECTED_API_VERSION}). Please deploy updated firmware.`
                    });
                    return false;
                } else {
                    setApiVersionError(null);
                    return true;
                }
            };

            const handleDataReceived = (event) => {
                try {
                    const value = event.target.value;
                    const decoder = new TextDecoder();
                    const rawData = decoder.decode(value);

                    console.log('BLE RX:', rawData);
                
                    // Clear any previous parse errors on successful decode
                    setDataParseErrors(prev => prev.filter(err => err.type !== 'decode'));
                
                    // Special debug logging for diagnostic messages
                    if (rawData.includes('DIAGNOSTIC')) {
                        console.log('🔧 DIAGNOSTIC MESSAGE DETECTED:', rawData);
                    }

                // Add to raw data log with message type detection
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    data: rawData,
                    type: 'data'
                };

                // Detect message types for better logging
                if (rawData.includes('ERROR:')) {
                    logEntry.type = 'error';
                } else if (rawData.includes('STATUS:')) {
                    logEntry.type = 'status';
                } else if (rawData.includes('HEARTBEAT:')) {
                    logEntry.type = 'heartbeat';
                } else if (rawData.includes('CONNECT:')) {
                    logEntry.type = 'connect';
                } else if (rawData.includes('PONG:')) {
                    logEntry.type = 'pong';
                }

                setRawDataLog(prev => [...prev.slice(-50), logEntry]);

                // Handle simple status/heartbeat messages that don't contain sensor data
                if (rawData.startsWith('HEARTBEAT:') || rawData.startsWith('PONG:') || rawData.startsWith('ERROR:')) {
                    // These messages don't contain sensor data, so don't update the main data state
                    // Just handle any specific status updates they might contain
                    if (rawData.includes('MODE:')) {
                        const modeMatch = rawData.match(/MODE:(\w+)/);
                        if (modeMatch) {
                            const mode = modeMatch[1];
                            setData(prev => ({
                                ...prev,
                                dataMode: mode,
                                simulationRunning: (mode === 'SIMULATED')
                            }));
                        }
                    }
                    return; // Don't process as sensor data
                }

                // Handle special diagnostic messages that don't follow standard format
                if (rawData.startsWith('DIAGNOSTIC_RESULTS:')) {
                    const diagnosticData = rawData.substring('DIAGNOSTIC_RESULTS:'.length);
                    console.log('Processing diagnostic results chunk:', diagnosticData);
                    try {
                        if (!diagnosticData || typeof diagnosticData !== 'string') {
                            throw new Error('Invalid diagnostic results format');
                        }
                        
                        // Remove any trailing semicolons and clean up the data
                        let cleanData = diagnosticData.replace(/;$/, '').trim();
                        
                        // Convert pipe separators to newlines and format properly
                        const results = cleanData.replace(/\|/g, '\n').replace(/\n+/g, '\n').trim();
                        console.log('Formatted diagnostic results chunk:', results);
                        
                        setDiagnosticResults(prev => {
                            const currentResults = prev || '';
                            // If this is the first chunk, replace; otherwise append
                            const newResults = currentResults.includes('=== ESP32 SYSTEM INFO ===') ? 
                                currentResults + '\n' + results : 
                                (currentResults ? currentResults + '\n' + results : results);
                            console.log('Updated diagnostic results length:', newResults.length);
                            return newResults;
                        });
                        setDiagnosticError(null);
                        
                        // Auto-switch to diagnostics tab when results arrive
                        setActiveTab('diagnostics');
                    } catch (diagError) {
                        console.error('Error processing diagnostic results:', diagError);
                        setDiagnosticError('Failed to process diagnostic results: ' + diagError.message);
                        setDiagnosticResults(prev => (prev || '') + '\n❌ Error processing results: ' + diagError.message);
                        
                        // Auto-switch to diagnostics tab even on error
                        setActiveTab('diagnostics');
                    }
                    return; // Don't process as sensor data
                }
                    
                if (rawData.startsWith('DIAGNOSTIC_STARTED:')) {
                    try {
                        // Clear any existing timeouts
                        if (window.diagnosticTimeouts) {
                            window.diagnosticTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                            window.diagnosticTimeouts.clear();
                        }
                        
                        setDiagnosticRunning(true);
                        setDiagnosticError(null);
                        setDiagnosticResults('🔄 Diagnostic mode started...\nRunning comprehensive system checks...\nThis may take 10-30 seconds...\n\n');
                        
                        // Auto-switch to diagnostics tab when diagnostic starts
                        setActiveTab('diagnostics');
                        
                        console.log('Diagnostic started, waiting for results...');
                    } catch (diagError) {
                        console.error('Error handling diagnostic start:', diagError);
                        setDiagnosticError('Failed to start diagnostic process: ' + diagError.message);
                        setDiagnosticRunning(false);
                        
                        // Auto-switch to diagnostics tab even on error
                        setActiveTab('diagnostics');
                    }
                    return; // Don't process as sensor data
                }
                    
                if (rawData.startsWith('DIAGNOSTIC_COMPLETE:')) {
                    const status = rawData.substring('DIAGNOSTIC_COMPLETE:'.length).trim();
                    try {
                        // Clear any pending timeouts
                        if (window.diagnosticTimeouts) {
                            window.diagnosticTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                            window.diagnosticTimeouts.clear();
                        }
                        
                        setDiagnosticRunning(false);
                        
                        if (status === 'SUCCESS') {
                            setDiagnosticResults(prev => {
                                const updatedResults = (prev || '') + '\n\n✅ Diagnostic completed successfully!';
                                // Send diagnostic data to webhook endpoint with updated results
                                setTimeout(() => sendDiagnosticToWebhook(updatedResults, data), 100);
                                return updatedResults;
                            });
                            setDiagnosticError(null);
                        } else if (status === 'FAILED' || status === 'ERROR') {
                            setDiagnosticResults(prev => {
                                const updatedResults = (prev || '') + '\n\n❌ Diagnostic completed with errors!';
                                // Send diagnostic data even on failure for troubleshooting
                                setTimeout(() => sendDiagnosticToWebhook(updatedResults, data, 'FAILED'), 100);
                                return updatedResults;
                            });
                            setDiagnosticError('Diagnostic process completed with errors');
                        } else {
                            setDiagnosticResults(prev => {
                                const updatedResults = (prev || '') + '\n\n⚠️ Diagnostic completed with unknown status: ' + status;
                                // Send diagnostic data with unknown status
                                setTimeout(() => sendDiagnosticToWebhook(updatedResults, data, 'UNKNOWN'), 100);
                                return updatedResults;
                            });
                        }
                    } catch (diagError) {
                        console.error('Error handling diagnostic completion:', diagError);
                        setDiagnosticError('Failed to complete diagnostic process: ' + diagError.message);
                        setDiagnosticRunning(false);
                    }
                    return; // Don't process as sensor data
                }

                // Parse the data format: messageId:timestamp,RPM:value;SPD:value;GPS:lat,lng;
                try {
                    // Validate raw data format before processing
                    if (!rawData || typeof rawData !== 'string' || rawData.trim().length === 0) {
                        throw new Error('Empty or invalid data received');
                    }
                    // Handle message counter prefix (messageId:data)
                    let dataToProcess = rawData;
                    let messageId = null;
                    
                    // Handle message counter prefix (messageId:data)
                    if (rawData.includes(':') && rawData.match(/^\d+:/)) {
                        const colonIndex = rawData.indexOf(':');
                        messageId = parseInt(rawData.substring(0, colonIndex));
                        dataToProcess = rawData.substring(colonIndex + 1);
                        console.log('Message ID:', messageId, 'Data:', dataToProcess);
                    } else {
                        // No message counter, use raw data directly
                        dataToProcess = rawData;
                        console.log('Processing data without message counter:', dataToProcess);
                    }
                    
                    const parts = dataToProcess.split(',');
                    if (parts.length >= 2) {
                        const timestamp = parseInt(parts[0]);
                        const dataString = parts.slice(1).join(',');

                        // Only create updates object for fields that are actually present
                        const dataUpdates = { timestamp };
                        let hasSensorData = false;

                        // Parse key-value pairs
                        const pairs = dataString.split(';').filter(p => p.length > 0);

                        pairs.forEach(pair => {
                            if (pair.includes(':')) {
                                const [key, value] = pair.split(':');

                                switch (key) {
                                    case 'RPM':
                                        dataUpdates.rpm = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'SPD':
                                        // Convert km/h to mph
                                        dataUpdates.speed = Math.round((parseInt(value) || 0) * 0.621371);
                                        hasSensorData = true;
                                        break;
                                    case 'COOLANT':
                                        // Convert Celsius to Fahrenheit
                                        dataUpdates.coolant = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'PRESSURE':
                                        dataUpdates.enginePressure = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'BATTERY':
                                        dataUpdates.batteryVoltage = (parseInt(value) || 0) / 100; // Assuming value is in centivolt
                                        hasSensorData = true;
                                        break;
                                    case 'AMBIENT':
                                        // Convert Celsius to Fahrenheit
                                        dataUpdates.ambientTemp = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'ENGINE_LOAD':
                                        dataUpdates.engineLoad = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'THROTTLE_POS':
                                        dataUpdates.throttlePos = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'INTAKE_TEMP':
                                        dataUpdates.intakeTemp = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'OIL_TEMP':
                                        dataUpdates.oilTemp = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'EXHAUST_TEMP':
                                        dataUpdates.exhaustTemp = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'FUEL_PRESSURE':
                                        dataUpdates.fuelPressure = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'FUEL_LEVEL':
                                        dataUpdates.fuelLevel = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'FUEL_TRIM_SHORT':
                                        dataUpdates.fuelTrimShort = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'FUEL_TRIM_LONG':
                                        dataUpdates.fuelTrimLong = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'FUEL_RATE':
                                        dataUpdates.fuelRate = (parseInt(value) || 0) / 100; // Convert from cL/h to L/h
                                        hasSensorData = true;
                                        break;
                                    case 'MAF_FLOW':
                                        dataUpdates.mafFlow = (parseInt(value) || 0) / 100; // Convert from cg/s to g/s
                                        hasSensorData = true;
                                        break;
                                    case 'O2_VOLTAGE':
                                        dataUpdates.o2Voltage = (parseInt(value) || 0) / 1000; // Convert from mV to V
                                        hasSensorData = true;
                                        break;
                                    case 'CATALYST_TEMP':
                                        dataUpdates.catalystTemp = Math.round(((parseInt(value) || 0) * 9/5) + 32);
                                        hasSensorData = true;
                                        break;
                                    case 'BOOST_PRESSURE':
                                        dataUpdates.boostPressure = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'TURBO_RPM':
                                        dataUpdates.turboRpm = parseInt(value) || 0;
                                        hasSensorData = true;
                                        break;
                                    case 'GPS':
                                        const coords = value.split(',');
                                        if (coords.length >= 2) {
                                            dataUpdates.gps = {
                                                lat: parseFloat(coords[0]) || 0,
                                                lng: parseFloat(coords[1]) || 0
                                            };
                                        }
                                        hasSensorData = true;
                                        break;
                                    case 'SAT':
                                        // Parse satellite count and indicator
                                        const satMatch = value.match(/^(\d+)(\([^)]+\))?/);
                                        if (satMatch) {
                                            dataUpdates.gps = {
                                                ...(dataUpdates.gps || {}),
                                                satellites: parseInt(satMatch[1]) || 0,
                                                satelliteIndicator: satMatch[2] || null
                                            };
                                        } else {
                                            dataUpdates.gps = {
                                                ...(dataUpdates.gps || {}),
                                                satellites: parseInt(value) || 0,
                                                satelliteIndicator: null
                                            };
                                        }
                                        break;
                                    case 'MODE':
                                        dataUpdates.dataMode = value;
                                        // Don't update simulationRunning from device - it's client-side now
                                        break;
                                    case 'ERROR':
                                        dataUpdates.lastError = value;
                                        break;
                                    case 'STATUS':
                                        // Parse status information like "OBD=REAL,GPS=OK,STORAGE=OK"
                                        const statusPairs = value.split(',');
                                        const statusObj = {};
                                        statusPairs.forEach(statusPair => {
                                            const [statusKey, statusValue] = statusPair.split('=');
                                            if (statusKey && statusValue) {
                                                statusObj[statusKey] = statusValue;
                                            }
                                        });
                                        dataUpdates.systemStatus = statusObj;
                                        break;
                                    case 'API_VERSION':
                                        const apiVersion = parseInt(value);
                                        dataUpdates.apiVersion = apiVersion;
                                        validateApiVersion(apiVersion);
                                        break;
                                    case 'CONNECT':
                                        // Handle connection messages that may include API_VERSION
                                        if (value.includes('API_VERSION:')) {
                                            const versionMatch = value.match(/API_VERSION:(\d+)/);
                                            if (versionMatch) {
                                                const apiVersion = parseInt(versionMatch[1]);
                                                dataUpdates.apiVersion = apiVersion;
                                                validateApiVersion(apiVersion);
                                            }
                                        }
                                        break;
                                }
                            }
                        });

                        // Only update state if we have actual data to update
                        if (Object.keys(dataUpdates).length > 1) { // More than just timestamp
                            setData(prev => {
                                const newData = { ...prev, ...dataUpdates };
                                
                                // Handle GPS updates properly by merging with existing GPS data
                                if (dataUpdates.gps) {
                                    newData.gps = { ...prev.gps, ...dataUpdates.gps };
                                }
                                
                                return newData;
                            });

                            // Add to history for charting only if we have sensor data
                            if (hasSensorData) {
                                setDataHistory(prev => {
                                    const currentData = prev.length > 0 ? prev[prev.length - 1] : {
                                        rpm: 0, speed: 0, coolant: 0, enginePressure: 0, batteryVoltage: 0,
                                        ambientTemp: 0, engineLoad: 0, throttlePos: 0, intakeTemp: 0, oilTemp: 0,
                                        exhaustTemp: 0, fuelPressure: 0, fuelLevel: 0, fuelTrimShort: 0,
                                        fuelTrimLong: 0, fuelRate: 0, mafFlow: 0, o2Voltage: 0, catalystTemp: 0,
                                        boostPressure: 0, turboRpm: 0
                                    };
                                    
                                    return [...prev, {
                                        timestamp: Date.now(),
                                        rpm: dataUpdates.rpm !== undefined ? dataUpdates.rpm : currentData.rpm,
                                        speed: dataUpdates.speed !== undefined ? dataUpdates.speed : currentData.speed,
                                        coolant: dataUpdates.coolant !== undefined ? dataUpdates.coolant : currentData.coolant,
                                        enginePressure: dataUpdates.enginePressure !== undefined ? dataUpdates.enginePressure : currentData.enginePressure,
                                        batteryVoltage: dataUpdates.batteryVoltage !== undefined ? dataUpdates.batteryVoltage : currentData.batteryVoltage,
                                        ambientTemp: dataUpdates.ambientTemp !== undefined ? dataUpdates.ambientTemp : currentData.ambientTemp,
                                        engineLoad: dataUpdates.engineLoad !== undefined ? dataUpdates.engineLoad : currentData.engineLoad,
                                        throttlePos: dataUpdates.throttlePos !== undefined ? dataUpdates.throttlePos : currentData.throttlePos,
                                        intakeTemp: dataUpdates.intakeTemp !== undefined ? dataUpdates.intakeTemp : currentData.intakeTemp,
                                        oilTemp: dataUpdates.oilTemp !== undefined ? dataUpdates.oilTemp : currentData.oilTemp,
                                        exhaustTemp: dataUpdates.exhaustTemp !== undefined ? dataUpdates.exhaustTemp : currentData.exhaustTemp,
                                        fuelPressure: dataUpdates.fuelPressure !== undefined ? dataUpdates.fuelPressure : currentData.fuelPressure,
                                        fuelLevel: dataUpdates.fuelLevel !== undefined ? dataUpdates.fuelLevel : currentData.fuelLevel,
                                        fuelTrimShort: dataUpdates.fuelTrimShort !== undefined ? dataUpdates.fuelTrimShort : currentData.fuelTrimShort,
                                        fuelTrimLong: dataUpdates.fuelTrimLong !== undefined ? dataUpdates.fuelTrimLong : currentData.fuelTrimLong,
                                        fuelRate: dataUpdates.fuelRate !== undefined ? dataUpdates.fuelRate : currentData.fuelRate,
                                        mafFlow: dataUpdates.mafFlow !== undefined ? dataUpdates.mafFlow : currentData.mafFlow,
                                        o2Voltage: dataUpdates.o2Voltage !== undefined ? dataUpdates.o2Voltage : currentData.o2Voltage,
                                        catalystTemp: dataUpdates.catalystTemp !== undefined ? dataUpdates.catalystTemp : currentData.catalystTemp,
                                        boostPressure: dataUpdates.boostPressure !== undefined ? dataUpdates.boostPressure : currentData.boostPressure,
                                        turboRpm: dataUpdates.turboRpm !== undefined ? dataUpdates.turboRpm : currentData.turboRpm
                                    }].slice(-100); // Keep last 100 entries
                                });
                            }
                        }
                    }
                } catch (parseError) {
                    console.error('Error parsing data:', parseError);
                    
                    // Add parse error to error log with details
                    const errorDetails = {
                        timestamp: new Date().toLocaleTimeString(),
                        type: 'parse',
                        message: parseError.message,
                        rawData: rawData ? rawData.substring(0, 100) + (rawData.length > 100 ? '...' : '') : 'null'
                    };
                    
                    setDataParseErrors(prev => [...prev.slice(-9), errorDetails]); // Keep last 10 errors
                    
                    setRawDataLog(prev => [...prev.slice(-50), {
                        timestamp: new Date().toLocaleTimeString(),
                        data: `PARSE ERROR: ${parseError.message} | Raw: ${errorDetails.rawData}`,
                        type: 'error'
                    }]);
                }
            } catch (outerError) {
                console.error('Critical error in data handler:', outerError);
                
                setRawDataLog(prev => [...prev.slice(-50), {
                    timestamp: new Date().toLocaleTimeString(),
                    data: `CRITICAL ERROR: ${outerError.message} | Handler failed completely`,
                    type: 'error'
                }]);
                
                // Reset diagnostic state on critical errors
                setDiagnosticRunning(false);
                setDiagnosticError('Critical error in data processing');
            }
        };

        const disconnect = () => {
                if (device && device.gatt.connected) {
                    device.gatt.disconnect();
                }
            };

            // Function to send commands to device with enhanced error handling
            const sendCommand = (command) => {
                try {
                    // Validate command input
                    if (!command || typeof command !== 'string' || command.trim().length === 0) {
                        throw new Error('Invalid command: empty or non-string command');
                    }
                    
                    // Sanitize command to prevent injection
                    const sanitizedCommand = command.trim().replace(/[^A-Z_]/g, '');
                    if (sanitizedCommand !== command.trim()) {
                        console.warn('Command sanitized:', command, '->', sanitizedCommand);
                    }
                    
                    if (characteristic && device && device.gatt && device.gatt.connected) {
                        try {
                            const message = `CMD:${sanitizedCommand}`;
                            
                            // Validate message length
                            if (message.length > 100) {
                                throw new Error('Command too long: ' + message.length + ' characters');
                            }
                            
                            characteristic.writeValue(new TextEncoder().encode(message));
                            console.log('Sent command:', message);
                            
                            setRawDataLog(prev => [...prev.slice(-50), {
                                timestamp: new Date().toLocaleTimeString(),
                                data: 'TX: ' + message,
                                type: 'tx'
                            }]);
                            
                            // Special handling for diagnostic commands
                            if (sanitizedCommand === 'DIAGNOSTIC') {
                                setDiagnosticError(null);
                                setDiagnosticResults('📡 Sending diagnostic command to device...\nWaiting for response...\n\n');
                                setDiagnosticRunning(true);
                                
                                // Auto-switch to diagnostics tab when command is sent
                                setActiveTab('diagnostics');
                                
                                const timeoutId = setTimeout(() => {
                                    setDiagnosticRunning(prevRunning => {
                                        if (prevRunning) {
                                            const timeoutMessage = '\n❌ TIMEOUT: Device did not respond within 45 seconds\n\nPossible causes:\n• Device is not connected\n• Device is busy with other operations\n• BLE connection is unstable\n• Device firmware issue\n\nTry disconnecting and reconnecting, then run diagnostics again.';
                                            setDiagnosticError('⏰ Diagnostic timeout - no response from device after 45 seconds');
                                            setDiagnosticResults(prev => {
                                                const updatedResults = prev + timeoutMessage;
                                                // Send timeout diagnostic data to webhook
                                                setTimeout(() => sendDiagnosticToWebhook(updatedResults, data, 'TIMEOUT'), 100);
                                                return updatedResults;
                                            });
                                            return false;
                                        }
                                        return prevRunning;
                                    });
                                }, 45000); // 45 second timeout
                                
                                // Store timeout ID for cleanup
                                if (!window.diagnosticTimeouts) window.diagnosticTimeouts = new Set();
                                window.diagnosticTimeouts.add(timeoutId);
                            }
                            
                        } catch (writeError) {
                            console.error('BLE write failed:', writeError);
                            setRawDataLog(prev => [...prev.slice(-50), {
                                timestamp: new Date().toLocaleTimeString(),
                                data: 'TX ERROR: BLE write failed for ' + sanitizedCommand + ' - ' + writeError.message,
                                type: 'error'
                            }]);
                            
                            if (sanitizedCommand === 'DIAGNOSTIC') {
                                setDiagnosticError('Failed to send diagnostic command: ' + writeError.message);
                                setDiagnosticRunning(false);
                            }
                        }
                    } else {
                        const connectionStatus = !device ? 'No device' : 
                                               !device.gatt ? 'No GATT' : 
                                               !device.gatt.connected ? 'Not connected' : 'Unknown state';
                        
                        console.warn('Cannot send command - device not connected:', connectionStatus);
                        setRawDataLog(prev => [...prev.slice(-50), {
                            timestamp: new Date().toLocaleTimeString(),
                            data: `TX ERROR: ${connectionStatus}, cannot send ${sanitizedCommand}`,
                            type: 'error'
                        }]);
                        
                        if (sanitizedCommand === 'DIAGNOSTIC') {
                            setDiagnosticError('Cannot run diagnostic: ' + connectionStatus);
                            setDiagnosticRunning(false);
                        }
                    }
                } catch (commandError) {
                    console.error('Command processing error:', commandError);
                    setRawDataLog(prev => [...prev.slice(-50), {
                        timestamp: new Date().toLocaleTimeString(),
                        data: 'COMMAND ERROR: ' + commandError.message,
                        type: 'error'
                    }]);
                    
                    if (command === 'DIAGNOSTIC') {
                        setDiagnosticError('Command processing error: ' + commandError.message);
                        setDiagnosticRunning(false);
                    }
                }
            };

            // Client-side simulation functions
            const generateSimulatedData = () => {
                const now = Date.now();
                const elapsed = clientSimulation.startTime ? (now - clientSimulation.startTime) / 1000 : 0;
                
                // Generate realistic simulated data
                const baseRpm = 1500 + Math.sin(elapsed * 0.1) * 300;
                const baseSpeed = 60 + Math.sin(elapsed * 0.05) * 15;
                const isHighPerformance = Math.random() > 0.7; // 30% chance of high performance mode
                const isIdling = baseRpm < 1200;
                const isHighLoad = Math.sin(elapsed * 0.08) > 0.5;
                
                return {
                    // Core engine parameters
                    rpm: Math.round(baseRpm + (Math.random() - 0.5) * 200),
                    speed: Math.round(baseSpeed + (Math.random() - 0.5) * 10),
                    coolant: Math.round(185 + (Math.random() - 0.5) * 10), // °F
                    engineLoad: Math.round(25 + Math.sin(elapsed * 0.08) * 15 + (Math.random() - 0.5) * 10),
                    throttlePos: Math.round(20 + Math.sin(elapsed * 0.12) * 10 + (Math.random() - 0.5) * 8),
                    
                    // Fuel system parameters
                    fuelLevel: Math.round(75 + (Math.random() - 0.5) * 5),
                    fuelPressure: Math.round(45 + (Math.random() - 0.5) * 8),
                    fuelTrimShort: Math.round((Math.random() - 0.5) * 10),
                    fuelTrimLong: Math.round((Math.random() - 0.5) * 6),
                    fuelRate: isIdling ? 2 + Math.random() : 8 + (Math.random() - 0.5) * 3,
                    
                    // Air flow and emissions
                    mafFlow: isIdling ? 3 + Math.random() * 2 : 15 + Math.sin(elapsed * 0.1) * 5 + (Math.random() - 0.5) * 2,
                    o2Voltage: 0.45 + (Math.random() - 0.5) * 0.2,
                    
                    // Temperature parameters
                    intakeTemp: Math.round(95 + (Math.random() - 0.5) * 15), // °F
                    oilTemp: Math.round(210 + (Math.random() - 0.5) * 20), // °F
                    exhaustTemp: Math.round(800 + (isHighLoad ? 200 : 0) + (Math.random() - 0.5) * 100), // °F
                    catalystTemp: Math.round(750 + (isHighLoad ? 150 : 0) + (Math.random() - 0.5) * 100), // °F
                    ambientTemp: Math.round(72 + (Math.random() - 0.5) * 10), // °F
                    
                    // Electrical and pressure
                    batteryVoltage: 14.2 + (Math.random() - 0.5) * 0.4,
                    enginePressure: Math.round(35 + (Math.random() - 0.5) * 8), // Atmospheric pressure in mbar
                    
                    // Turbo/boost parameters
                    boostPressure: isHighPerformance ? Math.round(8 + (Math.random() - 0.5) * 6) : Math.round((Math.random()) * 2),
                    turboRpm: isHighPerformance ? Math.round(80000 + (Math.random() - 0.5) * 40000) : Math.round(Math.random() * 20000),
                    
                    // GPS data
                    gps: {
                        lat: 37.7749 + (Math.random() - 0.5) * 0.01,
                        lng: -122.4194 + (Math.random() - 0.5) * 0.01,
                        satellites: 7 + Math.round((Math.random() - 0.5) * 4)
                    },
                    
                    // System status
                    timestamp: now,
                    dataMode: 'SIMULATED',
                    systemStatus: {
                        OBD: 'SIMULATED',
                        GPS: 'OK',
                        STORAGE: 'OK',
                        BLE: 'OK'
                    },
                    apiVersion: 1
                };
            };

            // Function to toggle client-side simulation
            const toggleSimulation = () => {
                if (clientSimulation.enabled) {
                    // Stop simulation
                    if (clientSimulation.interval) {
                        clearInterval(clientSimulation.interval);
                    }
                    setClientSimulation({
                        enabled: false,
                        startTime: null,
                        interval: null
                    });
                    setData(prev => ({
                        ...prev,
                        simulationRunning: false,
                        dataMode: 'DISABLED'
                    }));
                } else {
                    // Start simulation
                    const startTime = Date.now();
                    const interval = setInterval(() => {
                        const simData = generateSimulatedData();
                        setData(prev => ({
                            ...prev,
                            ...simData,
                            simulationRunning: true
                        }));
                        
                        // Add to history for charting
                        setDataHistory(prev => [...prev, {
                            timestamp: Date.now(),
                            rpm: simData.rpm || 0,
                            speed: simData.speed || 0,
                            coolant: simData.coolant || 0,
                            enginePressure: simData.enginePressure || 0,
                            batteryVoltage: simData.batteryVoltage || 0,
                            ambientTemp: simData.ambientTemp || 0,
                            engineLoad: simData.engineLoad || 0,
                            throttlePos: simData.throttlePos || 0,
                            intakeTemp: simData.intakeTemp || 0,
                            oilTemp: simData.oilTemp || 0,
                            exhaustTemp: simData.exhaustTemp || 0,
                            fuelPressure: simData.fuelPressure || 0,
                            fuelLevel: simData.fuelLevel || 0,
                            fuelTrimShort: simData.fuelTrimShort || 0,
                            fuelTrimLong: simData.fuelTrimLong || 0,
                            fuelRate: simData.fuelRate || 0,
                            mafFlow: simData.mafFlow || 0,
                            o2Voltage: simData.o2Voltage || 0,
                            catalystTemp: simData.catalystTemp || 0,
                            boostPressure: simData.boostPressure || 0,
                            turboRpm: simData.turboRpm || 0
                        }].slice(-100));
                    }, 1000);
                    
                    setClientSimulation({
                        enabled: true,
                        startTime: startTime,
                        interval: interval
                    });
                    
                    setData(prev => ({
                        ...prev,
                        simulationRunning: true,
                        dataMode: 'SIMULATED'
                    }));
                }
            };

            // Function to send diagnostic data to webhook endpoint
            const sendDiagnosticToWebhook = async (diagnosticResults, currentData, diagnosticStatus = 'SUCCESS') => {
                try {
                    // Extract diagnostic messages from raw data log
                    const diagnosticMessages = rawDataLog
                        .filter(entry => 
                            entry.data.includes('DIAGNOSTIC') || 
                            entry.data.includes('ESP32') ||
                            entry.data.includes('GPIO') ||
                            entry.data.includes('ADC') ||
                            entry.data.includes('I2C') ||
                            entry.data.includes('SPI') ||
                            entry.data.includes('OBD') ||
                            entry.data.includes('BLE') ||
                            entry.data.includes('SYSTEM') ||
                            entry.data.includes('VOLTAGE') ||
                            entry.data.includes('MEMORY') ||
                            entry.data.includes('HEAP')
                        )
                        .map(entry => `${entry.timestamp}: ${entry.data}`)
                        .join('\n');

                    // Prepare webhook payload matching the expected format
                    const webhookPayload = {
                        deviceId: device?.name || 'FreematicsCustom_' + (device?.id?.substring(0, 8) || 'Unknown'),
                        deviceName: device?.name || 'FreematicsCustom',
                        timestamp: new Date().toISOString(),
                        diagnosticType: 'hardware_diagnostic',
                        diagnosticStatus: diagnosticStatus,
                        issuesFound: countDiagnosticIssues(diagnosticResults),
                        diagnosticResults: diagnosticResults || 'No diagnostic data available',
                        
                        // Include raw diagnostic messages from the log
                        rawDiagnosticMessages: diagnosticMessages || 'No diagnostic messages captured',
                        
                        // Include recent raw data log entries for context
                        recentLogEntries: rawDataLog.slice(-50).map(entry => ({
                            timestamp: entry.timestamp,
                            type: entry.type || 'data',
                            message: entry.data
                        })),
                        
                        // System health summary from current data
                        systemHealth: {
                            engineLoad: currentData.engineLoad || 0,
                            coolantTemp: currentData.coolant || 0,
                            batteryVoltage: currentData.batteryVoltage || 0,
                            fuelLevel: currentData.fuelLevel || 0
                        },
                        
                        // Power analysis
                        powerAnalysis: {
                            inputVoltage: currentData.batteryVoltage || 0,
                            powerSource: currentData.batteryVoltage > 11 ? 'Vehicle Power' : 
                                        currentData.batteryVoltage > 4.5 ? 'USB Power' : 'Unknown',
                            voltageStatus: currentData.batteryVoltage > 12 ? 'OK' : 'LOW',
                            rail3v3: 'OK' // Assume OK if we're getting data
                        },
                        
                        // Hardware status from system status
                        hardwareStatus: {
                            bleStatus: currentData.systemStatus?.BLE || 'OK',
                            obdStatus: currentData.systemStatus?.OBD || currentData.dataMode || 'UNKNOWN',
                            gpsStatus: currentData.systemStatus?.GPS || 'OK',
                            storageStatus: currentData.systemStatus?.STORAGE || 'OK'
                        },
                        
                        // Generate recommendations based on diagnostic results and current data
                        recommendations: generateDiagnosticRecommendations(diagnosticResults, currentData)
                    };
                    
                    console.log('Sending diagnostic data to webhook:', webhookPayload);
                    
                    // Send POST request to webhook endpoint
                    const response = await fetch('/hookers/honey', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(webhookPayload)
                    });
                    
                    if (response.ok) {
                        console.log('Diagnostic data sent to webhook successfully');
                        setRawDataLog(prev => [...prev.slice(-50), {
                            timestamp: new Date().toLocaleTimeString(),
                            data: '📡 Diagnostic data sent to webhook endpoint successfully',
                            type: 'system'
                        }]);
                    } else {
                        console.error('Failed to send diagnostic data to webhook:', response.status, response.statusText);
                        setRawDataLog(prev => [...prev.slice(-50), {
                            timestamp: new Date().toLocaleTimeString(),
                            data: `❌ Webhook failed: ${response.status} ${response.statusText}`,
                            type: 'error'
                        }]);
                    }
                } catch (error) {
                    console.error('Error sending diagnostic data to webhook:', error);
                    setRawDataLog(prev => [...prev.slice(-50), {
                        timestamp: new Date().toLocaleTimeString(),
                        data: `❌ Webhook error: ${error.message}`,
                        type: 'error'
                    }]);
                }
            };
            
            // Function to count diagnostic issues from results text
            const countDiagnosticIssues = (diagnosticText) => {
                if (!diagnosticText) return 0;
                
                let issueCount = 0;
                const lowerText = diagnosticText.toLowerCase();
                
                // Count various issue indicators
                issueCount += (lowerText.match(/fail/g) || []).length;
                issueCount += (lowerText.match(/error/g) || []).length;
                issueCount += (lowerText.match(/warning/g) || []).length;
                issueCount += (lowerText.match(/critical/g) || []).length;
                issueCount += (lowerText.match(/no response/g) || []).length;
                
                return issueCount;
            };
            
            // Function to generate recommendations based on diagnostic results
            const generateDiagnosticRecommendations = (diagnosticText, currentData) => {
                const recommendations = [];
                
                if (!diagnosticText) return recommendations;
                
                const lowerText = diagnosticText.toLowerCase();
                
                // Power-related recommendations
                if (currentData.batteryVoltage < 12.0) {
                    recommendations.push('Check vehicle battery and charging system');
                }
                
                // OBD-related recommendations
                if (lowerText.includes('no response') && lowerText.includes('obd')) {
                    recommendations.push('Check OBD-II cable connection and vehicle ignition');
                }
                
                if (lowerText.includes('can') && lowerText.includes('fail')) {
                    recommendations.push('Verify CAN bus wiring and SN65HVD230 transceiver');
                }
                
                // Memory recommendations
                if (lowerText.includes('memory') && lowerText.includes('low')) {
                    recommendations.push('Restart device to free memory');
                }
                
                // Temperature recommendations
                if (lowerText.includes('hot') || lowerText.includes('temperature')) {
                    recommendations.push('Check device ventilation and ambient temperature');
                }
                
                // BLE recommendations
                if (lowerText.includes('ble') && lowerText.includes('fail')) {
                    recommendations.push('Restart device to reinitialize Bluetooth');
                }
                
                // Generic recommendations if no specific issues found
                if (recommendations.length === 0 && lowerText.includes('fail')) {
                    recommendations.push('Review diagnostic details for specific component issues');
                    recommendations.push('Check all cable connections and power supply');
                }
                
                return recommendations;
            };

            // Helper function to get range indicator text and color
            const getRangeInfo = (value, type) => {
                try {
                    if (value === null || value === undefined || isNaN(value)) {
                        return { text: 'No data', color: 'info' };
                    }
                    
                    const numValue = Number(value);
                    if (!isFinite(numValue)) {
                        return { text: 'Invalid', color: 'info' };
                    }

                    switch (type) {
                        case 'rpm':
                            if (numValue > 6000) return { text: 'Very High', color: 'danger' };
                            if (numValue > 4000) return { text: 'High', color: 'warning' };
                            if (numValue > 1000) return { text: 'Normal', color: 'normal' };
                            return { text: 'Idle', color: 'normal' };
                        case 'speed':
                            if (numValue > 80) return { text: 'Very Fast', color: 'danger' };
                            if (numValue > 60) return { text: 'Fast', color: 'warning' };
                            if (numValue > 0) return { text: 'Moving', color: 'normal' };
                            return { text: 'Stopped', color: 'normal' };
                        case 'coolant':
                            if (numValue > 220) return { text: 'Overheating', color: 'danger' };
                            if (numValue > 200) return { text: 'Hot', color: 'warning' };
                            if (numValue > 160) return { text: 'Normal', color: 'normal' };
                            return { text: 'Cold', color: 'normal' };
                        case 'atmospheric':
                            if (numValue < 950) return { text: 'Very Low (High Alt)', color: 'info' };
                            if (numValue < 1000) return { text: 'Low Pressure', color: 'info' };
                            if (numValue > 1040) return { text: 'High Pressure', color: 'info' };
                            return { text: 'Normal', color: 'normal' };
                        case 'pressure':
                            if (numValue < 10) return { text: 'Critical Low', color: 'danger' };
                            if (numValue < 20) return { text: 'Low', color: 'warning' };
                            if (numValue > 65) return { text: 'High', color: 'warning' };
                            return { text: 'Normal', color: 'normal' };
                        case 'battery':
                            if (numValue < 11.5) return { text: 'Critical', color: 'danger' };
                            if (numValue < 12.0) return { text: 'Low', color: 'warning' };
                            if (numValue > 14.5) return { text: 'High', color: 'warning' };
                            return { text: 'Good', color: 'normal' };
                        case 'engineLoad':
                            if (numValue > 90) return { text: 'Very High', color: 'danger' };
                            if (numValue > 75) return { text: 'High', color: 'warning' };
                            if (numValue > 20) return { text: 'Normal', color: 'normal' };
                            return { text: 'Light', color: 'normal' };
                        case 'fuelLevel':
                            if (numValue < 15) return { text: 'Very Low', color: 'danger' };
                            if (numValue < 25) return { text: 'Low', color: 'warning' };
                            return { text: 'OK', color: 'normal' };
                        case 'fuelTrim':
                            if (Math.abs(numValue) > 15) return { text: 'Problem', color: 'danger' };
                            if (Math.abs(numValue) > 10) return { text: 'High', color: 'warning' };
                            return { text: 'Normal', color: 'normal' };
                        default:
                            return { text: 'Unknown', color: 'info' };
                    }
                } catch (error) {
                    return { text: 'Error', color: 'info' };
                }
            };

            // Helper function to get tooltip content for metrics
            const getTooltipContent = (type, value) => {
                const tooltips = {
                    rpm: `Engine RPM measures crankshaft rotation speed. Normal: 600-900 idle, 1500-4000 driving. Higher RPM = more power but more fuel consumption.`,
                    speed: `Vehicle speed from transmission/wheel sensors. Measured in miles per hour (mph).`,
                    coolant: `Engine coolant temperature. Critical for preventing overheating. Normal: 180-220°F. Warning: >220°F. Danger: >240°F.`,
                    atmosphericPressure: `Atmospheric pressure measured by device barometric sensor. Used for altitude compensation and weather monitoring.
                                            <br/><strong>Sea Level:</strong> ~1013 mbar (14.7 psi)
                                            <br/><strong>High Altitude:</strong> Lower pressure
                                            <br/><strong>Weather:</strong> Varies with conditions`,
                    enginePressure: `Engine oil pressure from OBD-II system. Critical for engine lubrication.
                                            <br/><strong>Idle:</strong> 10-25 psi
                                            <br/><strong>Driving:</strong> 25-65 psi
                                            <br/><strong>Warning:</strong> &lt;10 psi (potential engine damage)`,
                    deviceVoltage: `Device input voltage from vehicle's 12V system. Powers the Freematics device and indicates vehicle electrical health.
                                            <br/><strong>Engine Off:</strong> 12.4-12.8V (good battery)
                                            <br/><strong>Engine Running:</strong> 13.8-14.4V (charging)
                                            <br/><strong>Warning:</strong> &lt;12.0V (weak battery/charging issue)`,
                    batteryVoltage: `Vehicle battery voltage from OBD-II system. May differ from device input voltage due to wiring resistance.
                                            <br/><strong>Engine Off:</strong> 12.4-12.8V (good battery)
                                            <br/><strong>Engine Running:</strong> 13.8-14.4V (charging)
                                            <br/><strong>Warning:</strong> &lt;12.0V (weak battery/charging issue)`,
                    ambientTemp: `Outside air temperature. Affects engine performance and cooling efficiency. Hot weather reduces power.`,
                    engineLoad: `How hard the engine works vs maximum capacity. Normal: 20-40% city, 40-70% highway. >85% sustained is high stress.`,
                    throttlePos: `Throttle valve opening. 0% = closed (idle), 100% = wide open. Normal: 0-20% cruise, 20-80% acceleration.`,
                    fuelLevel: `Fuel remaining in tank. Warning: <25%. Danger: <15%.`,
                    intakeTemp: `Air temperature entering engine. Affects combustion efficiency. Normal: 70-120°F. Cooler air provides more power.`,
                    oilTemp: `Engine oil temperature. Affects viscosity and lubrication. Normal: 180-250°F. Warning: >250°F.`,
                    fuelPressure: `Fuel rail pressure for injection. Normal: 35-65 psi (varies by engine). Warning: <30 or >70 psi.`,
                    fuelTrimShort: `Real-time fuel mixture adjustment. Positive = adding fuel, negative = reducing. Normal: -10% to +10%. >±15% indicates problems.`,
                    fuelTrimLong: `Learned fuel adjustment over time. Shows engine condition. Normal: -10% to +10%. >±15% indicates wear/problems.`,
                    satellites: `GPS satellites tracked. Minimum: 4 for 3D position. Good: 6-8. Excellent: 9+. More satellites = better accuracy.`
                };
                return tooltips[type] || 'No information available for this metric.';
            };

            // Periodic ping to keep connection alive
            useEffect(() => {
                if (isConnected) {
                    const pingInterval = setInterval(() => {
                        sendCommand('PING');
                    }, 30000); // Ping every 30 seconds

                    return () => clearInterval(pingInterval);
                }
            }, [isConnected]);

            // Helper function to get color class based on value and type with error handling
            const getColorClass = (value, type) => {
                try {
                    // Validate inputs
                    if (value === null || value === undefined || isNaN(value)) {
                        return 'info'; // Default for invalid values
                    }
                    
                    const numValue = Number(value);
                    if (!isFinite(numValue)) {
                        return 'info'; // Default for infinite or NaN values
                    }
                switch (type) {
                    case 'rpm':
                        if (value > 6000) return 'danger';
                        if (value > 4000) return 'warning';
                        return 'normal';
                    case 'speed':
                        if (value > 80) return 'danger';
                        if (value > 60) return 'warning';
                        return 'normal';
                    case 'coolant':
                        if (value > 220) return 'danger';
                        if (value > 200) return 'warning';
                        return 'normal';
                    case 'atmospheric':
                        return 'info'; // Atmospheric pressure is informational
                    case 'pressure':
                        if (value < 10) return 'danger';
                        if (value < 20) return 'warning';
                        return 'normal';
                    case 'battery':
                        if (value < 11.5) return 'danger';
                        if (value < 12.0) return 'warning';
                        return 'normal';
                    case 'ambient':
                        if (value > 100) return 'danger';
                        if (value > 85) return 'warning';
                        return 'normal';
                    case 'engineLoad':
                        if (value > 90) return 'danger';
                        if (value > 75) return 'warning';
                        return 'normal';
                    case 'throttle':
                        if (value > 90) return 'warning';
                        return 'normal';
                    case 'fuelLevel':
                        if (value < 15) return 'danger';
                        if (value < 25) return 'warning';
                        return 'normal';
                    case 'fuelTrim':
                        if (Math.abs(value) > 15) return 'danger';
                        if (Math.abs(value) > 10) return 'warning';
                        return 'normal';
                    case 'oilTemp':
                        if (value > 250) return 'danger';
                        if (value > 220) return 'warning';
                        return 'normal';
                    case 'exhaustTemp':
                        if (value > 1200) return 'danger';
                        if (value > 1000) return 'warning';
                        return 'normal';
                    default:
                        return 'info';
                }
            } catch (colorError) {
                console.warn('Error determining color class:', colorError, 'value:', value, 'type:', type);
                return 'info'; // Safe fallback
            }
            };

            return (
                <div className="dashboard">

                    {error && (
                        <div className="error-message">
                            {error}
                        </div>
                    )}

                    {!navigator.bluetooth && (
                        <div className="error-message">
                            Web Bluetooth is not supported in this browser. Please use Chrome or Edge with HTTPS enabled.
                            <br />
                            <small>Note: Safari has limited Web Bluetooth support. For best results, use Chrome or Edge.</small>
                        </div>
                    )}

                    {navigator.bluetooth && location.protocol !== 'https:' && location.hostname !== 'localhost' && (
                        <div className="error-message">
                            Web Bluetooth requires HTTPS. Please serve this page over HTTPS or use localhost for testing.
                        </div>
                    )}

                    <div className="status-panel">
                        <h3>System Status
                            <div className="status" style={{display: 'inline-flex', alignItems: 'center', marginLeft: '20px'}}>
                                <div className={`status-indicator ${isConnected ? 'connected' : ''}`}></div>
                                <span style={{marginLeft: '8px', marginRight: '10px'}}>{isConnected ? 'Connected' : 'Disconnected'}</span>
                                <button
                                    className="connect-btn"
                                    onClick={isConnected ? disconnect : connectToDevice}
                                    disabled={!navigator.bluetooth}
                                    style={{marginRight: '10px'}}
                                >
                                    {isConnected ? 'Disconnect' : 'Connect to Freematics'}
                                </button>
                            </div>
                            <button 
                                className={`sim-control-btn ${(data.simulationRunning || clientSimulation.enabled) ? 'stop' : ''}`}
                                onClick={toggleSimulation}
                                title={(data.simulationRunning || clientSimulation.enabled) ? 'Stop client simulation' : 'Start client simulation'}
                            >
                                {(data.simulationRunning || clientSimulation.enabled) ? '⏹ Stop Simulation' : '▶ Start Simulation'}
                            </button>
                            <button 
                                style={{marginLeft: '10px', padding: '8px 16px', fontSize: '14px', backgroundColor: '#6c757d', color: 'white', border: 'none', borderRadius: '5px', cursor: isConnected ? 'pointer' : 'not-allowed'}}
                                onClick={() => sendCommand('STATUS')}
                                disabled={!isConnected}
                                title="Request current system status"
                            >
                                🔄 Refresh Status
                            </button>
                            <button 
                                style={{marginLeft: '10px', padding: '8px 16px', fontSize: '14px', backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '5px', cursor: isConnected ? 'pointer' : 'not-allowed'}}
                                onClick={() => sendCommand('DIAGNOSTIC')}
                                disabled={!isConnected}
                                title="Run comprehensive hardware and system diagnostics"
                            >
                                🔧 Run Diagnostics
                            </button>
                        </h3>
                        <div>
                            <span className={`status-item ${data.dataMode.toLowerCase()}`}>
                                Data: {data.dataMode}
                            </span>
                            {Object.entries(data.systemStatus).map(([key, value]) => {
                                // Extract base status and indicator
                                const hasIndicator = value.includes('(') && value.includes(')');
                                const baseValue = hasIndicator ? value.split('(')[0] : value;
                                const indicator = hasIndicator ? value.match(/\(([^)]+)\)/)[1] : null;
                                
                                return (
                                    <span key={key} className={`status-item ${baseValue.toLowerCase()}`}>
                                        {key}: {baseValue}
                                        {indicator && (
                                            <small style={{fontSize: '0.7em', opacity: 0.8, marginLeft: '3px'}}>
                                                ({indicator})
                                            </small>
                                        )}
                                    </span>
                                );
                            })}
                        </div>
                        {data.lastError && (
                            <div style={{marginTop: '10px', padding: '10px', backgroundColor: '#f8d7da', color: '#721c24', borderRadius: '4px'}}>
                                <strong>Last Error:</strong> {data.lastError}
                            </div>
                        )}
                        {data.dataMode === 'DISABLED' && !clientSimulation.enabled && (
                            <div style={{marginTop: '10px', padding: '10px', backgroundColor: '#e2e3e5', color: '#6c757d', borderRadius: '4px'}}>
                                <strong>Info:</strong> Data collection is disabled. Click "Start Simulation" to begin receiving test data, or connect to a vehicle's OBD-II port for real data.
                            </div>
                        )}
                        {(data.dataMode === 'SIMULATED' || clientSimulation.enabled) && (
                            <div style={{marginTop: '10px', padding: '10px', backgroundColor: '#fff3cd', color: '#856404', borderRadius: '4px'}}>
                                <strong>Client Simulation Mode:</strong> Displaying realistic test data generated in the browser. All engine, fuel, emissions, and diagnostic parameters are simulated locally.
                            </div>
                        )}
                        {data.dataMode === 'REAL' && (
                            <div style={{marginTop: '10px', padding: '10px', backgroundColor: '#d4edda', color: '#155724', borderRadius: '4px'}}>
                                <strong>Real Vehicle Data:</strong> Connected to vehicle ECU. Displaying live sensor readings from engine, emissions, and diagnostic systems.
                            </div>
                        )}
                        <div style={{marginTop: '10px', fontSize: '0.9em', color: '#6c757d'}}>
                            <strong>Data Sources:</strong><br/>
                            • <strong>REAL:</strong> Live vehicle OBD-II data from device<br/>
                            • <strong>SIMULATED:</strong> Client-side test data generated in browser<br/>
                            • <strong>DISABLED:</strong> No data collection (hardware sensors only)<br/>
                            <strong>Controls:</strong> Use buttons to toggle client simulation or refresh device status.
                        </div>
                    </div>

                    <div className="metrics-grid">
                        <div className="metric-card">
                            <div className="metric-label">Engine RPM <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.rpm, 'rpm')}`}>{data.rpm.toLocaleString()}</div>
                            <span className={`range-indicator ${getRangeInfo(data.rpm, 'rpm').color}`}>
                                {getRangeInfo(data.rpm, 'rpm').text}
                            </span>
                            <small style={{color: (data.dataMode === 'SIMULATED' || clientSimulation.enabled) ? '#856404' : data.dataMode === 'DISABLED' && !clientSimulation.enabled ? '#6c757d' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {(data.dataMode === 'SIMULATED' || clientSimulation.enabled) ? 'Simulated Data' : data.dataMode === 'DISABLED' && !clientSimulation.enabled ? 'No Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('rpm', data.rpm)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Speed <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.speed, 'speed')}`}>{data.speed} <small>mph</small></div>
                            <span className={`range-indicator ${getRangeInfo(data.speed, 'speed').color}`}>
                                {getRangeInfo(data.speed, 'speed').text}
                            </span>
                            <small style={{color: (data.dataMode === 'SIMULATED' || clientSimulation.enabled) ? '#856404' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {(data.dataMode === 'SIMULATED' || clientSimulation.enabled) ? 'Simulated Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('speed', data.speed)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Coolant Temp <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.coolant, 'coolant')}`}>{data.coolant}°F</div>
                            <span className={`range-indicator ${getRangeInfo(data.coolant, 'coolant').color}`}>
                                {getRangeInfo(data.coolant, 'coolant').text}
                            </span>
                            <small style={{color: data.dataMode === 'SIMULATED' ? '#856404' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {data.dataMode === 'SIMULATED' ? 'Simulated Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('coolant', data.coolant)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Atmospheric Pressure <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.enginePressure, 'atmospheric')}`}>{data.enginePressure} <small>mbar</small></div>
                            <span className={`range-indicator ${getRangeInfo(data.enginePressure, 'atmospheric').color}`}>
                                {getRangeInfo(data.enginePressure, 'atmospheric').text}
                            </span>
                            <small style={{color: data.dataMode === 'SIMULATED' ? '#856404' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {data.dataMode === 'SIMULATED' ? 'Simulated Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('atmosphericPressure', data.enginePressure)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Device Input Voltage <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.batteryVoltage, 'battery')}`}>{data.batteryVoltage.toFixed(1)} <small>V</small></div>
                            <span className={`range-indicator ${getRangeInfo(data.batteryVoltage, 'battery').color}`}>
                                {getRangeInfo(data.batteryVoltage, 'battery').text}
                            </span>
                            <small style={{color: data.dataMode === 'SIMULATED' ? '#856404' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {data.dataMode === 'SIMULATED' ? 'Simulated Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('deviceVoltage', data.batteryVoltage)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Ambient Temp <span className="metric-info">?</span></div>
                            <div className={`metric-value ${getColorClass(data.ambientTemp, 'ambient')}`}>{data.ambientTemp}°F</div>
                            <span className={`range-indicator ${getRangeInfo(data.ambientTemp, 'ambient').color}`}>
                                {getRangeInfo(data.ambientTemp, 'ambient').text}
                            </span>
                            <small style={{color: data.dataMode === 'SIMULATED' ? '#856404' : 'transparent', minHeight: '1em', display: 'block'}}>
                                {data.dataMode === 'SIMULATED' ? 'Simulated Data' : '\u00A0'}
                            </small>
                            <div className="metric-tooltip">{getTooltipContent('ambientTemp', data.ambientTemp)}</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">GPS Satellites <span className="metric-info">?</span></div>
                            <div className="metric-value info">
                                {data.gps.satellites}
                                {data.gps.satelliteIndicator && (
                                    <small style={{color: '#856404', display: 'block', fontSize: '0.4em', marginTop: '5px'}}>
                                        {data.gps.satelliteIndicator}
                                    </small>
                                )}
                            </div>
                            <span className={`range-indicator ${data.gps.satellites >= 8 ? 'normal' : data.gps.satellites >= 6 ? 'warning' : 'danger'}`}>
                                {data.gps.satellites >= 8 ? 'Excellent' : data.gps.satellites >= 6 ? 'Good' : data.gps.satellites >= 4 ? 'Minimum' : 'Poor'}
                            </span>
                            <div className="metric-tooltip">{getTooltipContent('satellites', data.gps.satellites)}</div>
                        </div>
                    </div>

                    <div className="tabs">
                        <div 
                            className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                            onClick={() => setActiveTab('overview')}
                        >
                            Overview
                        </div>
                        <div 
                            className={`tab ${activeTab === 'performance' ? 'active' : ''}`}
                            onClick={() => setActiveTab('performance')}
                        >
                            Performance
                        </div>
                        <div 
                            className={`tab ${activeTab === 'temperatures' ? 'active' : ''}`}
                            onClick={() => setActiveTab('temperatures')}
                        >
                            Temperatures
                        </div>
                        <div 
                            className={`tab ${activeTab === 'percentages' ? 'active' : ''}`}
                            onClick={() => setActiveTab('percentages')}
                        >
                            Load & Levels
                        </div>
                        <div 
                            className={`tab ${activeTab === 'fuel' ? 'active' : ''}`}
                            onClick={() => setActiveTab('fuel')}
                        >
                            Fuel System
                        </div>
                        <div 
                            className={`tab ${activeTab === 'diagnostics' ? 'active' : ''}`}
                            onClick={() => setActiveTab('diagnostics')}
                        >
                            Diagnostics
                        </div>
                        <div 
                            className={`tab ${activeTab === 'reference' ? 'active' : ''}`}
                            onClick={() => setActiveTab('reference')}
                        >
                            OBD-II Reference
                        </div>
                    </div>

                    <div className="tab-content">
                        <div className={`tab-panel ${activeTab === 'overview' ? 'active' : ''}`}>
                            <div className="compact-metrics">
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.engineLoad, 'engineLoad')}`}>
                                        {data.engineLoad}%
                                    </div>
                                    <div className="compact-label">Engine Load <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${getRangeInfo(data.engineLoad, 'engineLoad').color}`}>
                                        {getRangeInfo(data.engineLoad, 'engineLoad').text}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('engineLoad', data.engineLoad)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.throttlePos, 'throttle')}`}>
                                        {data.throttlePos}%
                                    </div>
                                    <div className="compact-label">Throttle Position <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${data.throttlePos > 90 ? 'warning' : 'normal'}`}>
                                        {data.throttlePos > 90 ? 'Wide Open' : data.throttlePos > 50 ? 'High' : data.throttlePos > 20 ? 'Moderate' : data.throttlePos > 0 ? 'Light' : 'Closed'}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('throttlePos', data.throttlePos)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.fuelLevel, 'fuelLevel')}`}>
                                        {data.fuelLevel}%
                                    </div>
                                    <div className="compact-label">Fuel Level <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${getRangeInfo(data.fuelLevel, 'fuelLevel').color}`}>
                                        {getRangeInfo(data.fuelLevel, 'fuelLevel').text}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('fuelLevel', data.fuelLevel)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.intakeTemp, 'ambient')}`}>
                                        {data.intakeTemp}°F
                                    </div>
                                    <div className="compact-label">Intake Temp <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${data.intakeTemp > 120 ? 'warning' : data.intakeTemp > 70 ? 'normal' : 'cold'}`}>
                                        {data.intakeTemp > 120 ? 'Hot' : data.intakeTemp > 70 ? 'Normal' : 'Cold'}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('intakeTemp', data.intakeTemp)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.oilTemp, 'oilTemp')}`}>
                                        {data.oilTemp}°F
                                    </div>
                                    <div className="compact-label">Oil Temp <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${data.oilTemp > 250 ? 'danger' : data.oilTemp > 220 ? 'warning' : data.oilTemp > 180 ? 'normal' : 'cold'}`}>
                                        {data.oilTemp > 250 ? 'Too Hot' : data.oilTemp > 220 ? 'Hot' : data.oilTemp > 180 ? 'Normal' : 'Cold'}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('oilTemp', data.oilTemp)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.fuelPressure, 'pressure')}`}>
                                        {data.fuelPressure} psi
                                    </div>
                                    <div className="compact-label">Fuel Pressure <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${getRangeInfo(data.fuelPressure, 'pressure').color}`}>
                                        {getRangeInfo(data.fuelPressure, 'pressure').text}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('fuelPressure', data.fuelPressure)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.fuelTrimShort, 'fuelTrim')}`}>
                                        {data.fuelTrimShort > 0 ? '+' : ''}{data.fuelTrimShort}%
                                    </div>
                                    <div className="compact-label">Short Fuel Trim <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${getRangeInfo(data.fuelTrimShort, 'fuelTrim').color}`}>
                                        {getRangeInfo(data.fuelTrimShort, 'fuelTrim').text}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('fuelTrimShort', data.fuelTrimShort)}</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.fuelTrimLong, 'fuelTrim')}`}>
                                        {data.fuelTrimLong > 0 ? '+' : ''}{data.fuelTrimLong}%
                                    </div>
                                    <div className="compact-label">Long Fuel Trim <span className="metric-info">?</span></div>
                                    <span className={`range-indicator ${getRangeInfo(data.fuelTrimLong, 'fuelTrim').color}`}>
                                        {getRangeInfo(data.fuelTrimLong, 'fuelTrim').text}
                                    </span>
                                    <div className="metric-tooltip">{getTooltipContent('fuelTrimLong', data.fuelTrimLong)}</div>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'performance' ? 'active' : ''}`}>
                            <div className="chart-container">
                                <div className="chart-wrapper">
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'temperatures' ? 'active' : ''}`}>
                            <div className="chart-container">
                                <div className="chart-wrapper">
                                    <canvas ref={tempChartRef}></canvas>
                                </div>
                            </div>
                            <div className="compact-metrics">
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.catalystTemp, 'exhaustTemp')}`}>
                                        {data.catalystTemp}°F
                                    </div>
                                    <div className="compact-label">Catalyst Temp</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.exhaustTemp, 'exhaustTemp')}`}>
                                        {data.exhaustTemp}°F
                                    </div>
                                    <div className="compact-label">Exhaust Temp</div>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'percentages' ? 'active' : ''}`}>
                            <div className="chart-container">
                                <div className="chart-wrapper">
                                    <canvas ref={percentChartRef}></canvas>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'fuel' ? 'active' : ''}`}>
                            <div className="chart-container">
                                <div className="chart-wrapper">
                                    <canvas ref={fuelChartRef}></canvas>
                                </div>
                            </div>
                            <div className="compact-metrics">
                                <div className="compact-metric">
                                    <div className="compact-value info">
                                        {(data.fuelRate || 0).toFixed(2)} L/h
                                    </div>
                                    <div className="compact-label">Fuel Rate</div>
                                </div>
                                <div className="compact-metric">
                                    <div className="compact-value info">
                                        {(data.mafFlow || 0).toFixed(2)} g/s
                                    </div>
                                    <div className="compact-label">MAF Flow</div>
                                </div>
                                <div className="compact-metric">
                                    <div className="compact-value info">
                                        {(data.o2Voltage || 0).toFixed(3)} V
                                    </div>
                                    <div className="compact-label">O2 Sensor</div>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'reference' ? 'active' : ''}`}>
                            <div style={{padding: '20px', backgroundColor: '#f8f9fa', borderRadius: '8px', marginBottom: '20px'}}>
                                <h3 style={{color: '#212529', marginBottom: '15px'}}>🚗 OBD-II Data Reference Guide</h3>
                                <p style={{color: '#495057', marginBottom: '20px'}}>
                                    This reference explains what each OBD-II (On-Board Diagnostics) parameter means and why it's important for vehicle monitoring.
                                    OBD-II is a standardized system that allows external electronics to interface with a car's computer system.
                                </p>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '20px'}}>
                                
                                {/* Engine Performance Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#007bff', marginBottom: '15px', borderBottom: '2px solid #007bff', paddingBottom: '5px'}}>
                                        🔧 Engine Performance
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>RPM (Revolutions Per Minute)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            How fast the engine crankshaft is spinning. Higher RPM means more power but also more fuel consumption.
                                            <br/><strong>Normal:</strong> 600-900 idle, 1500-4000 driving
                                            <br/><strong>Warning:</strong> >4000 RPM sustained
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Vehicle Speed</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Current vehicle speed as measured by the transmission or wheel sensors.
                                            <br/><strong>Units:</strong> Miles per hour (mph)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Engine Load (%)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            How hard the engine is working relative to its maximum capacity. Higher load means more stress on engine components.
                                            <br/><strong>Normal:</strong> 20-40% city driving, 40-70% highway
                                            <br/><strong>Warning:</strong> >85% sustained
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Throttle Position (%)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            How far the throttle valve is open. 0% = closed (idle), 100% = wide open throttle (WOT).
                                            <br/><strong>Normal:</strong> 0-20% idle/cruise, 20-80% acceleration
                                        </p>
                                    </div>
                                </div>

                                {/* Temperature Monitoring Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#dc3545', marginBottom: '15px', borderBottom: '2px solid #dc3545', paddingBottom: '5px'}}>
                                        🌡️ Temperature Monitoring
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Coolant Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Engine coolant temperature. Critical for preventing engine overheating and damage.
                                            <br/><strong>Normal:</strong> 180-220°F (82-104°C)
                                            <br/><strong>Warning:</strong> &gt;220°F (&gt;104°C)
                                            <br/><strong>Danger:</strong> &gt;240°F (&gt;116°C)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Intake Air Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Temperature of air entering the engine. Affects combustion efficiency and power output.
                                            <br/><strong>Normal:</strong> 70-120°F (21-49°C)
                                            <br/><strong>Note:</strong> Cooler air is denser and provides more power
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Oil Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Engine oil temperature. Oil viscosity changes with temperature, affecting lubrication.
                                            <br/><strong>Normal:</strong> 180-250°F (82-121°C)
                                            <br/><strong>Warning:</strong> &gt;250°F (&gt;121°C)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Exhaust Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Temperature of exhaust gases. Indicates combustion efficiency and turbo/catalyst health.
                                            <br/><strong>Normal:</strong> 800-1200°F (427-649°C)
                                            <br/><strong>Warning:</strong> &gt;1200°F (&gt;649°C)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Catalyst Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Catalytic converter temperature. Must be hot enough to work but not so hot it's damaged.
                                            <br/><strong>Normal:</strong> 750-1100°F (399-593°C)
                                            <br/><strong>Warning:</strong> &gt;1100°F (&gt;593°C)
                                        </p>
                                    </div>
                                </div>

                                {/* Fuel System Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#28a745', marginBottom: '15px', borderBottom: '2px solid #28a745', paddingBottom: '5px'}}>
                                        ⛽ Fuel System
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Fuel Level (%)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Percentage of fuel remaining in the tank.
                                            <br/><strong>Warning:</strong> &lt;25% (low fuel)
                                            <br/><strong>Danger:</strong> &lt;15% (very low fuel)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Fuel Pressure (psi)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Pressure in the fuel rail. Must be sufficient for proper fuel injection.
                                            <br/><strong>Normal:</strong> 35-65 psi (varies by engine)
                                            <br/><strong>Warning:</strong> &lt;30 psi or &gt;70 psi
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Fuel Rate (L/h)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Current fuel consumption rate in liters per hour.
                                            <br/><strong>Idle:</strong> 1-3 L/h
                                            <br/><strong>Highway:</strong> 8-15 L/h
                                            <br/><strong>Heavy load:</strong> 15-30+ L/h
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Short Term Fuel Trim (%)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Real-time fuel mixture adjustment. Positive = adding fuel, negative = reducing fuel.
                                            <br/><strong>Normal:</strong> -10% to +10%
                                            <br/><strong>Warning:</strong> &gt;±15% (possible vacuum leak or sensor issue)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Long Term Fuel Trim (%)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Learned fuel mixture adjustment over time. Shows long-term engine condition.
                                            <br/><strong>Normal:</strong> -10% to +10%
                                            <br/><strong>Warning:</strong> &gt;±15% (engine wear or system problem)
                                        </p>
                                    </div>
                                </div>

                                {/* Air Flow & Emissions Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#6f42c1', marginBottom: '15px', borderBottom: '2px solid #6f42c1', paddingBottom: '5px'}}>
                                        💨 Air Flow & Emissions
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>MAF Flow (g/s)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Mass Air Flow - amount of air entering the engine in grams per second.
                                            <br/><strong>Idle:</strong> 2-7 g/s
                                            <br/><strong>Cruise:</strong> 8-25 g/s
                                            <br/><strong>WOT:</strong> 25-80+ g/s (depends on engine size)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>O2 Sensor Voltage (V)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Oxygen sensor voltage indicates air/fuel mixture richness.
                                            <br/><strong>Rich mixture:</strong> 0.7-1.0V (more fuel)
                                            <br/><strong>Lean mixture:</strong> 0.1-0.3V (less fuel)
                                            <br/><strong>Normal:</strong> Constantly switching between rich/lean
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Boost Pressure (psi)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Turbocharger or supercharger boost pressure above atmospheric.
                                            <br/><strong>Naturally Aspirated:</strong> 0 psi
                                            <br/><strong>Turbocharged:</strong> 5-20+ psi (varies by tune)
                                            <br/><strong>Note:</strong> Higher boost = more power but more stress
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Turbo RPM</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Turbocharger shaft speed in revolutions per minute.
                                            <br/><strong>Idle:</strong> 0-20,000 RPM
                                            <br/><strong>Boost:</strong> 80,000-200,000+ RPM
                                            <br/><strong>Note:</strong> Extremely high speeds require precise balancing
                                        </p>
                                    </div>
                                </div>

                                {/* Electrical & Pressure Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#fd7e14', marginBottom: '15px', borderBottom: '2px solid #fd7e14', paddingBottom: '5px'}}>
                                        ⚡ Electrical & Pressure
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Battery Voltage (V)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Electrical system voltage. Critical for all electronic components.
                                            <br/><strong>Engine Off:</strong> 12.4-12.8V (good battery)
                                            <br/><strong>Engine Running:</strong> 13.8-14.4V (charging)
                                            <br/><strong>Warning:</strong> &lt;12.0V (weak battery/charging issue)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Engine Pressure (psi)</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Oil pressure in the engine lubrication system.
                                            <br/><strong>Idle:</strong> 10-25 psi
                                            <br/><strong>Driving:</strong> 25-65 psi
                                            <br/><strong>Warning:</strong> &lt;10 psi (potential engine damage)
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>Ambient Temperature</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Outside air temperature. Affects engine performance and cooling efficiency.
                                            <br/><strong>Impact:</strong> Hot weather reduces power, cold weather affects fuel economy
                                        </p>
                                    </div>
                                </div>

                                {/* GPS & Location Section */}
                                <div style={{backgroundColor: '#ffffff', padding: '20px', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                    <h4 style={{color: '#17a2b8', marginBottom: '15px', borderBottom: '2px solid #17a2b8', paddingBottom: '5px'}}>
                                        🛰️ GPS & Location
                                    </h4>
                                    
                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>GPS Coordinates</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Latitude and longitude position from GPS satellites.
                                            <br/><strong>Format:</strong> Decimal degrees (e.g., 37.7749, -122.4194)
                                            <br/><strong>Accuracy:</strong> Typically 3-5 meters with good signal
                                        </p>
                                    </div>

                                    <div style={{marginBottom: '15px'}}>
                                        <strong style={{color: '#212529'}}>GPS Satellites</strong>
                                        <p style={{fontSize: '0.9em', color: '#495057', margin: '5px 0'}}>
                                            Number of GPS satellites currently being tracked.
                                            <br/><strong>Minimum:</strong> 4 satellites for 3D position
                                            <br/><strong>Good:</strong> 6-8 satellites
                                            <br/><strong>Excellent:</strong> 9+ satellites
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div style={{marginTop: '30px', padding: '20px', backgroundColor: '#e7f3ff', borderRadius: '8px', border: '1px solid #007bff'}}>
                                <h4 style={{color: '#004085', marginBottom: '15px'}}>📚 Understanding OBD-II Standards</h4>
                                <div style={{fontSize: '0.9em', color: '#004085', lineHeight: '1.6'}}>
                                    <p><strong>What is OBD-II?</strong> On-Board Diagnostics II is a standardized system that allows external devices to access vehicle diagnostic information. It became mandatory on all cars sold in the US after 1996.</p>
                                    
                                    <p><strong>PIDs (Parameter IDs):</strong> Each data point has a unique identifier called a PID. For example, PID 0x0C is Engine RPM, PID 0x0D is Vehicle Speed.</p>
                                    
                                    <p><strong>Data Modes:</strong></p>
                                    <ul style={{marginLeft: '20px'}}>
                                        <li><strong>REAL:</strong> Live data from your vehicle's ECU (Engine Control Unit)</li>
                                        <li><strong>SIMULATED:</strong> Test data generated for demonstration purposes</li>
                                        <li><strong>DISABLED:</strong> No OBD-II data collection active</li>
                                    </ul>
                                    
                                    <p><strong>Why Monitor These Values?</strong> Regular monitoring helps detect problems early, optimize fuel economy, ensure emissions compliance, and prevent costly engine damage.</p>
                                    
                                    <p><strong>Warning Signs:</strong> Values outside normal ranges often indicate maintenance needs, sensor failures, or mechanical problems that should be addressed promptly.</p>
                                </div>
                            </div>
                        </div>

                        <div className={`tab-panel ${activeTab === 'diagnostics' ? 'active' : ''}`}>
                            {/* Error Display Section */}
                            {(diagnosticError || dataParseErrors.length > 0) && (
                                <div style={{marginBottom: '20px'}}>
                                    {diagnosticError && (
                                        <div style={{
                                            backgroundColor: '#f8d7da', 
                                            color: '#721c24', 
                                            padding: '10px', 
                                            borderRadius: '5px',
                                            marginBottom: '10px',
                                            border: '1px solid #f5c6cb'
                                        }}>
                                            <strong>🚨 Diagnostic Error:</strong> {diagnosticError}
                                            <button 
                                                style={{
                                                    marginLeft: '10px', 
                                                    padding: '2px 8px', 
                                                    fontSize: '0.8em', 
                                                    backgroundColor: '#dc3545', 
                                                    color: 'white', 
                                                    border: 'none', 
                                                    borderRadius: '3px',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => setDiagnosticError(null)}
                                                title="Clear diagnostic error"
                                            >
                                                ✕ Clear
                                            </button>
                                        </div>
                                    )}
                                    
                                    {dataParseErrors.length > 0 && (
                                        <div style={{
                                            backgroundColor: '#fff3cd', 
                                            color: '#856404', 
                                            padding: '10px', 
                                            borderRadius: '5px',
                                            border: '1px solid #ffeaa7'
                                        }}>
                                            <strong>⚠️ Data Parse Errors ({dataParseErrors.length}):</strong>
                                            <button 
                                                style={{
                                                    marginLeft: '10px', 
                                                    padding: '2px 8px', 
                                                    fontSize: '0.8em', 
                                                    backgroundColor: '#ffc107', 
                                                    color: 'black', 
                                                    border: 'none', 
                                                    borderRadius: '3px',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => setDataParseErrors([])}
                                                title="Clear parse errors"
                                            >
                                                ✕ Clear
                                            </button>
                                            <div style={{fontSize: '0.8em', marginTop: '5px', maxHeight: '100px', overflowY: 'auto'}}>
                                                {dataParseErrors.slice(-3).map((error, idx) => (
                                                    <div key={idx} style={{marginTop: '3px'}}>
                                                        <strong>{error.timestamp}:</strong> {error.message}
                                                        <br/><small>Data: {error.rawData}</small>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="compact-metrics">
                                <div className="compact-metric">
                                    <div className="compact-value info">
                                        {(data.boostPressure || 0)} psi
                                    </div>
                                    <div className="compact-label">Boost Pressure</div>
                                </div>
                                <div className="compact-metric">
                                    <div className="compact-value info">
                                        {(data.turboRpm || 0).toLocaleString()} RPM
                                    </div>
                                    <div className="compact-label">Turbo RPM</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.batteryVoltage, 'battery')}`}>
                                        {(data.batteryVoltage || 0).toFixed(1)} V
                                    </div>
                                    <div className="compact-label">Device Input Voltage</div>
                                </div>
                                <div className="compact-metric">
                                    <div className={`compact-value ${getColorClass(data.enginePressure, 'atmospheric')}`}>
                                        {(data.enginePressure || 0)} mbar
                                    </div>
                                    <div className="compact-label">Atmospheric Pressure</div>
                                </div>
                            </div>
                            
                            <div style={{marginTop: '20px', padding: '15px', backgroundColor: '#f8f9fa', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                <h4 style={{color: '#212529', marginBottom: '15px'}}>System Health Summary</h4>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', fontSize: '0.9em', color: '#495057'}}>
                                    <div><strong>Engine Load:</strong> {(data.engineLoad || 0)}% {(data.engineLoad || 0) > 85 ? '⚠️' : '✅'}</div>
                                    <div><strong>Coolant Temp:</strong> {(data.coolant || 0)}°F {(data.coolant || 0) > 220 ? '🔥' : '✅'}</div>
                                    <div><strong>Oil Temp:</strong> {(data.oilTemp || 0)}°F {(data.oilTemp || 0) > 250 ? '🔥' : '✅'}</div>
                                    <div><strong>Fuel Level:</strong> {(data.fuelLevel || 0)}% {(data.fuelLevel || 0) < 25 ? '⛽' : '✅'}</div>
                                    <div><strong>Battery:</strong> {(data.batteryVoltage || 0).toFixed(1)}V {(data.batteryVoltage || 0) < 12.0 ? '🔋' : '✅'}</div>
                                    <div><strong>Fuel Trim:</strong> {Math.abs(data.fuelTrimShort || 0) > 10 ? '⚠️' : '✅'} ST: {(data.fuelTrimShort || 0)}%</div>
                                </div>
                            </div>

                            <div style={{marginTop: '20px', padding: '15px', backgroundColor: '#f8f9fa', borderRadius: '8px', border: '1px solid #dee2e6'}}>
                                <h4 style={{color: '#212529', marginBottom: '15px'}}>Hardware Diagnostics 
                                    <button 
                                        style={{marginLeft: '10px', padding: '5px 10px', fontSize: '0.8em', backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '5px', cursor: isConnected && !diagnosticRunning ? 'pointer' : 'not-allowed'}}
                                        onClick={() => sendCommand('DIAGNOSTIC')}
                                        disabled={!isConnected || diagnosticRunning}
                                        title="Run comprehensive hardware and system diagnostics"
                                    >
                                        {diagnosticRunning ? '🔄 Running...' : '🔧 Run Full Diagnostic'}
                                    </button>
                                </h4>
                                
                                {diagnosticResults ? (
                                    <div style={{
                                        backgroundColor: diagnosticError ? '#fff5f5' : '#ffffff', 
                                        color: diagnosticError ? '#721c24' : '#212529',
                                        padding: '15px', 
                                        borderRadius: '5px', 
                                        fontFamily: 'monospace', 
                                        fontSize: '0.85em', 
                                        whiteSpace: 'pre-wrap',
                                        maxHeight: '400px',
                                        overflowY: 'auto',
                                        border: diagnosticError ? '2px solid #dc3545' : '2px solid #28a745',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                    }}>
                                        {diagnosticResults}
                                        {diagnosticRunning && (
                                            <div style={{
                                                marginTop: '15px', 
                                                padding: '10px', 
                                                backgroundColor: '#cce5ff', 
                                                color: '#004085',
                                                borderRadius: '5px',
                                                textAlign: 'center',
                                                border: '1px solid #007bff',
                                                fontWeight: 'bold'
                                            }}>
                                                🔄 Diagnostic in progress... Please wait.
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div style={{
                                        padding: '25px', 
                                        textAlign: 'center', 
                                        color: '#495057', 
                                        backgroundColor: '#ffffff',
                                        border: '2px dashed #dee2e6',
                                        borderRadius: '8px',
                                        fontSize: '0.9em'
                                    }}>
                                        {isConnected ? (
                                            <>
                                                <strong>Click "Run Full Diagnostic" to scan hardware, pins, buses, and system components.</strong>
                                                <br /><br />
                                                This will help identify connection issues, hardware problems, and configuration errors.
                                            </>
                                        ) : (
                                            <>
                                                <strong>🔌 Connect to a device first to run diagnostics.</strong>
                                                <br /><br />
                                                Diagnostics require an active BLE connection to the Freematics device.
                                            </>
                                        )}
                                    </div>
                                )}
                                
                                <div style={{marginTop: '15px', fontSize: '0.85em', color: '#495057', backgroundColor: '#f8f9fa', padding: '10px', borderRadius: '5px', border: '1px solid #e9ecef'}}>
                                    <strong>Diagnostic Features:</strong><br/>
                                    • ADC pin voltage testing (GPIO 36, 39, 34, 35, 32, 33, etc.)<br/>
                                    • Digital pin state checking (GPIO 2, 4, 5, 16, 17, 18, etc.)<br/>
                                    • I2C bus scanning for connected devices (SDA=21, SCL=22)<br/>
                                    • SPI pin state verification (MISO=19, MOSI=23, SCK=18, SS=5)<br/>
                                    • OBD-II interface testing with multiple baud rates<br/>
                                    • ESP32 system information and health checks<br/>
                                    • Power supply voltage analysis<br/>
                                    • BLE connectivity verification<br/>
                                    • Automatic issue detection and recommendations
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="gps-container">
                        <h3>GPS Location</h3>
                        <div className="gps-coords">
                            Latitude: {data.gps.lat.toFixed(6)}°
                        </div>
                        <div className="gps-coords">
                            Longitude: {data.gps.lng.toFixed(6)}°
                        </div>
                        <div className="gps-coords">
                            Satellites: {data.gps.satellites}
                            {data.gps.satelliteIndicator && (
                                <small style={{color: '#856404', marginLeft: '10px'}}>
                                    {data.gps.satelliteIndicator}
                                </small>
                            )}
                        </div>
                    </div>

                    <div className="data-log">
                        <h3>Raw Data Log 
                            <button 
                                style={{marginLeft: '10px', padding: '5px 10px', fontSize: '0.8em'}}
                                onClick={() => sendCommand('STATUS')}
                                disabled={!isConnected}
                            >
                                Request Status
                            </button>
                            <button 
                                style={{marginLeft: '5px', padding: '5px 10px', fontSize: '0.8em'}}
                                onClick={() => setRawDataLog([])}
                            >
                                Clear Log
                            </button>
                        </h3>
                        {rawDataLog.slice(-20).reverse().map((entry, index) => (
                            <div key={index} className={`log-entry ${entry.type || 'data'}`}>
                                <strong>{entry.timestamp}:</strong> {entry.data}
                            </div>
                        ))}
                        {rawDataLog.length === 0 && (
                            <div className="log-entry">No data received yet...</div>
                        )}
                        <div style={{marginTop: '10px', fontSize: '0.9em', color: '#6c757d'}}>
                            Total messages: {rawDataLog.length} | 
                            Connected: {isConnected ? 'Yes' : 'No'} |
                            API Version: {data.apiVersion !== null ? data.apiVersion : 'Unknown'} |
                            Last update: {rawDataLog.length > 0 ? rawDataLog[rawDataLog.length - 1].timestamp : 'Never'}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FreematicsDashboard />);
    </script>
</body>
</html>
